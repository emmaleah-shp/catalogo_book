---
title: "`r titulo`"
date: "`r format(Sys.time(), '%d %B, %Y')`"
author: "OCUC"
output:
  pdf_document: 
    latex_engine: xelatex
header-includes:
  \usepackage{fontspec, fancyhdr, booktabs}
mainfont: Arial
params:
  titulo:  titulo
  show_code: yes
---

```{r setup, include=FALSE}

pacman::p_load(tidyselect, tidyverse, dplyr, glue, knitr, stringr, magrittr, sf, ggmap, ggplot2, flextable, data.table, sp, scales, devtools, tinytex, writexl, webshot, readr)
library(rmarkdown)
library(pdftools)
library(webshot)

knitr::opts_chunk$set(echo = TRUE, ft.tabcolsep=0)
flextable::use_df_printer()
options(cli.num_colors = 1)
```

Este es un informe sobre **`r titulo_capa`** que incluye un **analisis de completitud de fichas, numero do observaciones unicos, y un extento** .

```{r leer-shp, include=FALSE}
require(sf)
capa<-sf::st_read(path, layer=str_glue("{titulo_capa}"))
obs<- dim(capa)
```

Hay **`r obs[1]` observaciones** y **`r obs[2]` variables** .

\par

```{=tex}
\begin{center} 
DIAGNOSIS:
\end{center}
```
```{r diagnosing, fig.align='center',echo=FALSE, warning=FALSE}
library(dplyr)
capa_diagnosis<-diagnosticar(capa)
require(knitr)
require(flextable)
library(magrittr)

colourer <- col_bin(
  palette = c("#DD3E2C","transparent"),
  domain = c(0,100), 
  bins = c(0, 99,100))

colourer2 <- col_numeric(
  palette = c("#ABD9E9","#FFFFBF"),
  domain = c(0,100))

ft <- flextable(capa_diagnosis)
ft <- theme_booktabs(ft, bold_header = TRUE) %>% 
  flextable::align(align = "center", part="all") %>%
  bg(bg = colourer, j = ~ pc_completo, part = "body") %>%
    bg(bg = colourer2, j = ~ pc_repetido, part = "body") %>%
  colformat_double(j = ~ pc_completo, digits = 2) %>% 
  colformat_double(j = ~ pc_repetido, digits = 2) %>% 
  fontsize(part = "all", size=9) 

autofit(ft)
```

**Diccionario:**

\par

**rowname:** Nombre del columna

\par

**tipo:** Forma de el variable

\par

**vacios:** Número de celdas vacías en la columna

\par

**whitespace:** Número de celdas con solo espacios blancos en la columna

\par

**n_unico:** Número de celdas distintas en la columna

\par

**pc_completo:** Porcentaje de celdas vacías en la columna

\par

**pc_repetido:** Porcentaje de repeticiones

\par

```{r plotting1, echo = FALSE, include=FALSE}
library(sf)
library(ggplot2)
library(tmap)
library(ggmap)

ex <- st_bbox(capa)
ex<-st_as_sfc(ex)%>%
  st_as_sf()
ex<-sf::st_transform(ex, 4326)
exx <- st_bbox(ex)
left<- as.double(exx[1])
bottom<- as.double(exx[2])
right<-as.double(exx[3])
top<-as.double(exx[4])
```

\newpage

**El Bounding Box es:**

\par

Izquierda: `r left`

\par

Derecha: `r right`

\par

Superior: `r top`

\par

Inferior: `r bottom`

```{r plotting2, echo = FALSE}
library(sf)
library(leaflet)
library(mapview)
library(webshot) 
library(htmlwidgets)
m <-leaflet() %>% addTiles() %>%
  addRectangles(
    lng1=left, lat1=top,
    lng2=right, lat2=bottom,
    fillColor = "transparent"
  )
mapshot(m, file =  glue("images/{titulo_capa}_plot.png"))

```

```{r printing-map, echo = FALSE, fig.align='center', out.extra = "", out.width = "100%"}
knitr::include_graphics( glue("images/{titulo_capa}_plot.png"))
```

```{=html}
<style>
  
</style>
```
